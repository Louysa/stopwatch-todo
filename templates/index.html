<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Gothic Stopwatch & Todo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Crimson+Text:wght@400;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="container">
      <h1 class="gothic-title">Gothic Timekeeper</h1>
      
      <div class="stopwatch-container">
        <div class="time-display">00:00:00</div>
        <div class="controls">
          <button id="startBtn" class="gothic-btn">Start</button>
          <button id="stopBtn" class="gothic-btn">Stop</button>
          <button id="resetBtn" class="gothic-btn">Reset</button>
        </div>
      </div>

      <div class="todo-container">
        <h2 class="gothic-subtitle">Tasks of the Night</h2>
        <div class="todo-input">
          <input type="text" id="todoInput" placeholder="Enter a new task...">
          <button id="addTodo" class="gothic-btn">Add</button>
        </div>
        <ul id="todoList" class="todo-list">
          {% for task in tasks %}
          <li data-id="{{ task.id }}">
            <div class="task-content">
              <input type="checkbox" class="task-checkbox" {% if task.completed %}checked{% endif %}>
              <span class="task-text {% if task.completed %}completed{% endif %}">{{ task.task }}</span>
            </div>
            <button class="delete-btn">×</button>
          </li>
          {% endfor %}
        </ul>
      </div>

      <div class="stats-container">
        <h2 class="gothic-subtitle">Time Logs</h2>
        <div class="stats-list">
          {% for stat in stats %}
          <div class="stat-item">
            <span class="stat-date">{{ stat.date }}</span>
            <span class="stat-duration">{{ (stat.total_duration / 3600)|round(2) }} hours</span>
            <span class="stat-sessions">{{ stat.sessions }} sessions</span>
          </div>
          {% endfor %}
        </div>
        <div class="time-logs-list">
          {% for log in time_logs %}
          <div class="time-log-item">
            <span class="log-date">{{ log.date }}</span>
            <span class="log-time">{{ log.start_time_formatted }} - {{ log.end_time_formatted }}</span>
            <span class="log-duration">{{ (log.duration / 60)|round(1) }} minutes</span>
            {% if log.description %}
            <span class="log-description">{{ log.description }}</span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <script>
      let time = 0;
      let intervalId = null;
      let startTime = null;
      
      const timeDisplay = document.querySelector('.time-display');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const resetBtn = document.getElementById('resetBtn');
      const container = document.querySelector('.container');
      const todoContainer = document.querySelector('.todo-container');
      const title = document.querySelector('.gothic-title');

      function updateDisplay() {
        const hours = Math.floor(time / 3600);
        const minutes = Math.floor((time % 3600) / 60);
        const seconds = time % 60;
        timeDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }

      function enterFullScreen() {
        container.classList.add('fullscreen');
        todoContainer.style.display = 'none';
        title.style.display = 'none';
        startBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        timeDisplay.classList.add('fullscreen-timer');
      }

      function exitFullScreen() {
        container.classList.remove('fullscreen');
        todoContainer.style.display = 'block';
        title.style.display = 'block';
        startBtn.style.display = 'block';
        resetBtn.style.display = 'block';
        timeDisplay.classList.remove('fullscreen-timer');
      }

      async function logTimeToServer() {
        if (startTime) {
          const endTime = new Date();

          try {
            await fetch('/api/time-logs', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                description: '',
                start_time: startTime.toISOString(),
                end_time: endTime.toISOString()
              })
            });
            // Reload the page to show updated logs
            window.location.reload();
          } catch (error) {
            console.error('Error logging time:', error);
          }
        }
      }
      
      // Stopwatch functionality  
      startBtn.addEventListener('click', () => {
        if (!intervalId) {
          startTime = new Date();
          intervalId = setInterval(() => {
            time++;
            updateDisplay();
          }, 1000);
          enterFullScreen();
        }
      });

      stopBtn.addEventListener('click', async () => {
        clearInterval(intervalId);
        intervalId = null;
        await logTimeToServer();
        exitFullScreen();
      });

      resetBtn.addEventListener('click', async() => {
        clearInterval(intervalId);
        intervalId = null;
        if(startTime){
          await logTimeToServer();
        }
        time = 0;
        updateDisplay();
        exitFullScreen();
      });

      // Todo list functionality
      const todoInput = document.getElementById('todoInput');
      const addTodoBtn = document.getElementById('addTodo');
      const todoList = document.getElementById('todoList');

      async function addTodo() {
        const todoText = todoInput.value.trim();
        if (todoText) {
          try {
            const response = await fetch('/api/tasks',{
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                task: todoText,
              }),
            });
            const task = await response.json();
            const li = document.createElement('li');
            
            li.dataset.id = task.id;
            li.innerHTML = `
              <div class="task-content">
                <input type="checkbox" class="task-checkbox">
                <span class="task-text">${todoText}</span>
              </div>
              <button class="delete-btn">×</button>
            `;

            todoList.insertBefore(li,todoList.firstChild);
            todoInput.value = '';
            setTaskListeners(li);
          } catch (error) {
            console.error('Error adding task:', error);
          }
        }
      }

      function setTaskListeners(li){
        const checkbox = li.querySelector('.task-checkbox');
        const deleteBtn = li.querySelector('.delete-btn');
        const taskText = li.querySelector('.task-text');

        checkbox.addEventListener('change', async () => {
          try{
            await fetch(`/api/tasks/${li.dataset.id}/toggle`,{
              method: 'POST',
            });
            taskText.classList.toggle('completed');
          } catch (error) {
            console.error('Error toggling task:', error);
          }
        });

        deleteBtn.addEventListener('click', async () => {
          try{
            await fetch(`/api/tasks/${li.dataset.id}`,{
              method: 'DELETE',
            });
            li.remove();
          } catch (error) {
            console.error('Error deleting task:', error);
          }
        });
      }

      document.querySelectorAll('#todoList li').forEach(setTaskListeners);
       
      addTodoBtn.addEventListener('click', addTodo);
      todoInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addTodo();
        }
      });
    </script>
  </body>
</html>
