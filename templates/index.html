<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Gothic Stopwatch</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Crimson+Text:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  </head>
  <body>
    <div class="nav-controls">
        <a href="{{ url_for('logout') }}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
    <div class="user-controls">
      <span>{{ session['user']['email'] }}</span>
      <a href="{{ url_for('logout') }}" class="btn">Logout</a>
    </div>
    <div class="icon-buttons">
      <button id="tasksBtn" class="icon-btn" title="Tasks">
        <i class="fas fa-tasks"></i>
      </button>
      <button id="logsBtn" class="icon-btn" title="Time Logs">
        <i class="fas fa-history"></i>
      </button>
    </div>

    <!-- Tasks Side Panel -->
    <div id="tasksPanel" class="side-panel">
      <div class="panel-content">
        <div class="panel-header">
          <h2 class="gothic-subtitle">Tasks of the Night</h2>
          <button id="closeTasksBtn" class="icon-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="todo-input">
          <input type="text" id="todoInput" placeholder="Enter a new task...">
          <button id="addTodo" class="gothic-btn">
            <i class="fas fa-plus"></i>
            <span>Add</span>
          </button>
        </div>
        <ul id="todoList" class="todo-list">
          {% for task in tasks %}
          <li data-id="{{ task.id }}">
            <div class="task-content">
              <input type="checkbox" class="task-checkbox" {% if task.completed %}checked{% endif %}>
              <span class="task-text {% if task.completed %}completed{% endif %}">{{ task.task }}</span>
            </div>
            <button class="delete-btn">
              <i class="fas fa-times"></i>
            </button>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="container">
      <h1 class="gothic-title">Sude Kronometre</h1>
      <div class="stopwatch-container">
        <div class="time-display">00:00</div>
        <div class="timer-controls">
          <button class="start-btn">Start</button>
          <button class="pause-btn" style="display: none;">Pause</button>
          <button class="stop-btn" style="display: none;">Stop</button>
          <button class="reset-btn" style="display: none;">Reset</button>
        </div>
      </div>
    </div>

    <!-- Time Logs Popup -->
    <div class="popup" id="logsPopup">
        <div class="popup-header">
            <h3>Time Logs</h3>
            <button class="close-popup-btn" onclick="closePopup()">&times;</button>
        </div>
        <div class="time-logs-container">
            <!-- Logs will be populated here -->
        </div>
    </div>

    <!-- Overlay for popup -->
    <div class="overlay" id="overlay"></div>

    <script>
      let startTime, intervalId, time = 0, isPaused = false;
      let activeTime = 0;
      let lastResumeTime = null;
      
      const timeDisplay = document.querySelector('.time-display');
      const startBtn = document.querySelector('.start-btn');
      const container = document.querySelector('.container');
      const title = document.querySelector('.gothic-title');

      // Popup functionality
      const logsBtn = document.getElementById('logsBtn');
      const logsPopup = document.getElementById('logsPopup');
      const overlay = document.getElementById('overlay');

      function showPopup() {
        logsPopup.classList.add('active');
        overlay.classList.add('active');
        getTimeLogs(); // Fetch and display logs when popup opens
      }

      function closePopup() {
        logsPopup.classList.remove('active');
        overlay.classList.remove('active');
      }

      // Time logs functionality
      async function getTimeLogs() {
        try {
          const response = await fetch('/get_logs');
          if (!response.ok) {
            throw new Error('Failed to fetch logs');
          }
          
          const logs = await response.json();
          displayLogs(logs);
        } catch (error) {
          console.error('Error fetching logs:', error);
          displayError('Failed to load time logs');
        }
      }

      function displayLogs(logs) {
        const container = document.querySelector('.time-logs-container');
        container.innerHTML = ''; // Clear existing logs
        
        if (logs.length === 0) {
          container.innerHTML = '<div class="no-logs">No time logs found</div>';
          return;
        }

        logs.forEach(log => {
          const logElement = document.createElement('div');
          logElement.className = 'time-log-item';
          
          // Format the date
          const date = new Date(log.date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
          
          // Format the duration
          const hours = Math.floor(log.duration / 3600);
          const minutes = Math.floor((log.duration % 3600) / 60);
          const seconds = log.duration % 60;
          const duration = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
          
          logElement.innerHTML = `
            <span class="log-date">${date}</span>
            <span class="log-duration">${duration}</span>
          `;
          
          container.appendChild(logElement);
        });
      }

      function displayError(message) {
        const container = document.querySelector('.time-logs-container');
        container.innerHTML = `<div class="error-message">${message}</div>`;
      }

      // Event Listeners
      document.querySelector('.logs-btn').addEventListener('click', showPopup);
      overlay.addEventListener('click', closePopup);

      function startTimer() {
        if (!intervalId) {
          startTime = new Date().getTime() - (time * 1000);
          intervalId = setInterval(updateTimer, 1000);
          isPaused = false;
          
          // Update button visibility
          startBtn.style.display = 'none';
          document.querySelector('.stop-btn').style.display = 'inline-block';
          document.querySelector('.reset-btn').style.display = 'inline-block';
        }
      }

      function updateTimer() {
        if (!isPaused) {
          time++;
          updateDisplay();
        }
      }

      function updateDisplay() {
        const hours = Math.floor(time / 3600);
        const minutes = Math.floor((time % 3600) / 60);
        const seconds = time % 60;
        timeDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }

      function pauseTimer() {
        isPaused = !isPaused;
        const pauseBtn = document.querySelector('.pause-btn');
        pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
      }

      function stopTimer() {
        if (intervalId) {
          clearInterval(intervalId);
          logTimeToServer();
          intervalId = null;
          
          // Reset display and buttons
          time = 0;
          updateDisplay();
          startBtn.style.display = 'inline-block';
          document.querySelector('.stop-btn').style.display = 'none';
          document.querySelector('.reset-btn').style.display = 'none';
          document.querySelector('.pause-btn').textContent = 'Pause';
          isPaused = false;
        }
      }

      function resetTimer() {
        time = 0;
        updateDisplay();
        if (isPaused) {
          document.querySelector('.pause-btn').textContent = 'Pause';
          isPaused = false;
        }
      }

      // Space key event listener
      document.addEventListener('keydown', function(event) {
        if (event.code === 'Space' && document.activeElement.tagName !== 'INPUT') {
          event.preventDefault();
          if (!intervalId) {
            startTimer();
          } else {
            pauseTimer();
          }
        }
      });

      // Button event listeners
      startBtn.addEventListener('click', startTimer);
      document.querySelector('.stop-btn').addEventListener('click', stopTimer);
      document.querySelector('.reset-btn').addEventListener('click', resetTimer);
      document.querySelector('.pause-btn').addEventListener('click', pauseTimer);

      async function logTimeToServer() {
        try {
          const endTime = new Date().getTime();
          const response = await fetch('/log_time', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              startTime: startTime,
              endTime: endTime,
              duration: time // Send the actual seconds counted
            })
          });
          
          if (response.ok) {
            console.log('Time logged successfully');
            // Refresh the logs display
            getTimeLogs();
          } else {
            console.error('Failed to log time');
          }
        } catch (error) {
          console.error('Error logging time:', error);
        }
      }

      function enterFullScreen() {
        container.classList.add('fullscreen');
        title.style.display = 'none';
        startBtn.style.display = 'none';
        timeDisplay.classList.add('fullscreen-timer');
        
        try {
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen();
          }
        } catch (err) {
          console.log('Fullscreen error:', err);
        }
        
        const controls = container.querySelector('.timer-controls');
        controls.innerHTML = '';
        
        const stopBtn = document.createElement('button');
        stopBtn.className = 'btn stop-btn';
        stopBtn.innerHTML = '<i class="fas fa-pause"></i><span>Stop</span>';
        controls.appendChild(stopBtn);
        
        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn reset-btn';
        resetBtn.innerHTML = '<i class="fas fa-stop"></i><span>End</span>';
        controls.appendChild(resetBtn);
        
        stopBtn.addEventListener('click', () => {
          if (!isPaused) {
            pauseTimer();
          } else {
            resumeTimer();
          }
        });
        
        resetBtn.addEventListener('click', endTimer);
      }

      function exitFullScreen() {
        try {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          }
        } catch (err) {
          console.log('Exit fullscreen error:', err);
        }
        
        container.classList.remove('fullscreen');
        title.style.display = 'block';
        startBtn.style.display = 'inline-block';
        timeDisplay.classList.remove('fullscreen-timer');
        
        const stopBtn = document.querySelector('.stop-btn');
        const resetBtn = document.querySelector('.reset-btn');
        if (stopBtn) stopBtn.remove();
        if (resetBtn) resetBtn.remove();
        
        time = 0;
        updateDisplay();
        isPaused = false;
        intervalId = null;
      }

      // Tasks panel functionality with local storage
      const tasksBtn = document.getElementById('tasksBtn');
      const tasksPanel = document.getElementById('tasksPanel');
      const closeTasksBtn = document.getElementById('closeTasksBtn');

      // Load tasks panel state from local storage
      const isTasksPanelOpen = localStorage.getItem('tasksPanelOpen') === 'true';
      if (isTasksPanelOpen) {
        tasksPanel.classList.add('show');
        container.classList.add('side-panel-open');
      }

      tasksBtn.addEventListener('click', () => {
        tasksPanel.classList.add('show');
        container.classList.add('side-panel-open');
        localStorage.setItem('tasksPanelOpen', 'true');
      });

      closeTasksBtn.addEventListener('click', () => {
        tasksPanel.classList.remove('show');
        container.classList.remove('side-panel-open');
        localStorage.setItem('tasksPanelOpen', 'false');
      });

      // Close tasks panel when clicking outside
      window.addEventListener('click', (e) => {
        if (e.target === tasksPanel) {
          tasksPanel.classList.remove('show');
          container.classList.remove('side-panel-open');
          localStorage.setItem('tasksPanelOpen', 'false');
        }
      });

      // Update container margin when tasks panel state changes
      tasksPanel.addEventListener('transitionend', () => {
        if (tasksPanel.classList.contains('show')) {
          container.classList.add('side-panel-open');
        } else {
          container.classList.remove('side-panel-open');
        }
      });

      // Todo list functionality
      const todoInput = document.getElementById('todoInput');
      const addTodoBtn = document.getElementById('addTodo');
      const todoList = document.getElementById('todoList');

      async function addTodo() {
        const todoText = todoInput.value.trim();
        if (todoText) {
          try {
            const response = await fetch('/api/tasks',{
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                task: todoText,
              }),
            });
            const task = await response.json();
            const li = document.createElement('li');
            
            li.dataset.id = task.id;
            li.innerHTML = `
              <div class="task-content">
                <input type="checkbox" class="task-checkbox">
                <span class="task-text">${todoText}</span>
              </div>
              <button class="delete-btn">
                <i class="fas fa-times"></i>
              </button>
            `;

            todoList.insertBefore(li,todoList.firstChild);
            todoInput.value = '';
            setTaskListeners(li);
          } catch (error) {
            console.error('Error adding task:', error);
          }
        }
      }

      function setTaskListeners(li){
        const checkbox = li.querySelector('.task-checkbox');
        const deleteBtn = li.querySelector('.delete-btn');
        const taskText = li.querySelector('.task-text');

        checkbox.addEventListener('change', async () => {
          try{
            await fetch(`/api/tasks/${li.dataset.id}/toggle`,{
              method: 'POST',
            });
            taskText.classList.toggle('completed');
          } catch (error) {
            console.error('Error toggling task:', error);
          }
        });

        deleteBtn.addEventListener('click', async () => {
          try{
            await fetch(`/api/tasks/${li.dataset.id}`,{
              method: 'DELETE',
            });
            li.remove();
          } catch (error) {
            console.error('Error deleting task:', error);
          }
        });
      }

      document.querySelectorAll('#todoList li').forEach(setTaskListeners);
       
      addTodoBtn.addEventListener('click', addTodo);
      todoInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addTodo();
        }
      });
    </script>
  </body>
</html>
